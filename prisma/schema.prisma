generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                    String                      @id @default(cuid())
  name                  String
  birthdate             DateTime
  allergies             String?
  school                String?
  medicalNotes          String?
  emergencyContactName  String?
  emergencyContactPhone String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  bookings              Booking[]
  orderItems            OrderItem[]
  igniteSubscriptions   IgniteSubscriptionStudent[]

  @@map("students")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  type        ProductType
  price       Decimal     @db.Money
  duration    Int?
  description String
  ageMin      Int
  ageMax      Int
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  bookings    Booking[]
  orderItems  OrderItem[]

  @@map("products")
}

model Location {
  id                 String              @id @default(cuid())
  name               String
  address            String
  capacity           Int
  timezone           String              @default("Australia/Sydney")
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  bookings           Booking[]
  events             Event[]
  recurringTemplates RecurringTemplate[]

  @@map("locations")
}

model Booking {
  id         String        @id @default(cuid())
  studentId  String
  productId  String
  locationId String
  eventId    String?
  startDate  DateTime
  endDate    DateTime
  status     BookingStatus @default(PENDING)
  totalPrice Decimal       @db.Money
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  event      Event?        @relation(fields: [eventId], references: [id])
  location   Location      @relation(fields: [locationId], references: [id])
  product    Product       @relation(fields: [productId], references: [id])
  student    Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model Order {
  id                    String      @id @default(cuid())
  customerEmail         String
  customerName          String
  stripePaymentIntentId String?     @unique
  status                OrderStatus @default(PENDING)
  totalAmount           Decimal     @db.Money
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  orderItems            OrderItem[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  studentId   String
  bookingDate DateTime
  price       Decimal  @db.Money
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  student     Student  @relation(fields: [studentId], references: [id])

  @@map("order_items")
}

model Event {
  id                  String             @id @default(cuid())
  title               String
  description         String?
  type                EventType
  status              EventStatus        @default(SCHEDULED)
  startDateTime       DateTime
  endDateTime         DateTime
  isRecurring         Boolean            @default(false)
  maxCapacity         Int                @default(10)
  currentCount        Int                @default(0)
  locationId          String
  recurringTemplateId String?
  instructorId        String?
  instructorNotes     String?
  ageMin              Int?
  ageMax              Int?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  bookings            Booking[]
  location            Location           @relation(fields: [locationId], references: [id])
  recurringTemplate   RecurringTemplate? @relation(fields: [recurringTemplateId], references: [id])

  @@map("events")
}

model RecurringTemplate {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        EventType
  startTime   String
  endTime     String
  duration    Int
  daysOfWeek  Int[]
  startDate   DateTime
  endDate     DateTime?
  maxCapacity Int       @default(10)
  locationId  String
  ageMin      Int?
  ageMax      Int?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  events      Event[]
  location    Location  @relation(fields: [locationId], references: [id])

  @@map("recurring_templates")
}

enum ProductType {
  CAMP
  BIRTHDAY
  SUBSCRIPTION
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum EventType {
  CAMP
  BIRTHDAY
  SUBSCRIPTION
  RECURRING_SESSION
}

enum EventStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model IgniteSubscription {
  id                    String                      @id @default(cuid())
  stripeSubscriptionId  String                      @unique
  stripeCustomerId      String
  stripePriceId         String
  customerEmail         String
  customerName          String?
  igniteSessionId       String?
  studentNames          Json?
  status                IgniteSubscriptionStatus    @default(ACTIVE)
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  canceledAt            DateTime?
  cancelAtPeriodEnd     Boolean                     @default(false)
  weeklyAmount          Decimal                     @db.Money
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  students              IgniteSubscriptionStudent[]

  @@map("ignite_subscriptions")
}

model IgniteSubscriptionStudent {
  id                   String             @id @default(cuid())
  igniteSubscriptionId String
  studentId            String
  createdAt            DateTime           @default(now())
  igniteSubscription   IgniteSubscription @relation(fields: [igniteSubscriptionId], references: [id], onDelete: Cascade)
  student              Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([igniteSubscriptionId, studentId])
  @@map("ignite_subscription_students")
}

enum IgniteSubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  TRIALING
}
